<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>login in</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        @font-face {
            font-family: 'Qager';
            src: url('/static/Qager-zrlmw.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: #000;
            font-family: 'Qager', 'Press Start 2P', cursive !important;
            overflow: hidden;
            cursor: default; /* Changed from: cursor: none; */
        }
        .login-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 10;
        }
        .login-title {
            color: #00ff00;
            font-size: 8em;
            margin-bottom: 0.2em;
            font-family: 'Qager', 'Press Start 2P', cursive !important;
            text-align: center;
        }
        .sid-row {
            display: flex;
            gap: 2em;
            justify-content: center;
            margin-bottom: 0.3em;
        }
        .sid-col {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }
        .sid-label {
            color: #00ff00;
            font-size: 1.1em;
            margin-bottom: 0.3em;
            font-family: 'Qager', 'Press Start 2P', cursive !important;
        }
        .sid-input {
            width: 220px;
            max-width: 90vw;
            background: transparent;
            border: 4px solid #00ff00;
            color: #00ff00;
            font-size: 1.1em;
            font-family: 'Qager', 'Press Start 2P', cursive !important;
            padding: 0.5em 1em;
            margin: 0.2em auto 0.3em auto;
            display: block;
            box-sizing: border-box;
            outline: none;
            text-align: left;
            cursor: text; /* Enable mouse interaction */
            pointer-events: auto; /* Enable mouse interaction */
        }
        .login-btn {
            width: 400px;
            max-width: 90vw;
            background: transparent;
            border: 4px solid #00ff00;
            color: #00ff00;
            font-size: 1.3em;
            font-family: 'Qager', 'Press Start 2P', cursive !important;
            padding: 0.5em 1em;
            margin: 0.3em auto 0 auto;
            display: block;
            box-sizing: border-box;
            text-align: center;
            cursor: pointer; /* Enable mouse interaction */
            pointer-events: auto; /* Enable mouse interaction */
            transition: background 0.2s, color 0.2s;
        }
        .login-btn:hover, .login-btn:focus {
            background: #00ff00;
            color: #000;
        }
        
        /* Подсказка по управлению */
        .keyboard-hint {
            position: fixed;
            bottom: 30px;
            left: 0;
            width: 100%;
            color: #00ff00;
            font-size: 1.2em;
            font-family: 'Qager', 'Press Start 2P', cursive !important;
            text-align: center;
            z-index: 20;
            text-shadow: 0 0 10px #00ff00;
        }
        
        /* Стиль для сообщений об ошибках */
        .error-message {
            color: #ff0000;
            font-size: 1.2em;
            font-family: 'Qager', 'Press Start 2P', cursive !important;
            margin-bottom: 1em;
            text-align: center;
            text-shadow: 0 0 10px #ff0000;
            animation: blink 1.5s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .sid-desc {
            color: #00ff00;
            font-size: 1.1em;
            margin-bottom: 1.2em;
            font-family: 'Qager', 'Press Start 2P', cursive !important;
            text-align: center;
        }
        
        /* Remember Me Checkbox Styles */
        .remember-me-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 1em 0;
            width: 400px;
            max-width: 90vw;
        }
        
        .remember-checkbox {
            appearance: none;
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #00ff00;
            background: transparent;
            position: relative;
            margin-right: 10px;
            cursor: pointer;
            pointer-events: auto;
        }
        
        .remember-checkbox:checked::before {
            content: "✓";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #00ff00;
            font-size: 14px;
            text-shadow: 0 0 5px #00ff00;
        }
        
        .remember-checkbox:focus {
            box-shadow: 0 0 10px #00ff00;
            outline: none;
        }
        
        .remember-label {
            color: #00ff00;
            font-size: 1em;
            font-family: 'Qager', 'Press Start 2P', cursive !important;
            cursor: pointer;
            pointer-events: auto;
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="login-title" data-glitch>login in</div>
        {% if error_message %}
        <div class="error-message" data-glitch>{{ error_message }}</div>
        {% endif %}
        <form class="form" action="{{ url_for('login') }}" method="POST">
            <div class="sid-row">
                <div class="sid-col">
                    <label class="sid-label" for="sid1">SID1</label>
                    <input type="password" id="sid1" name="sid1" class="sid-input" required>
                </div>
                <div class="sid-col">
                    <label class="sid-label" for="sid3">SID3</label>
                    <input type="password" id="sid3" name="sid3" class="sid-input" required>
                </div>
            </div>
            <div class="sid-row">
                <div class="sid-col">
                    <label class="sid-label" for="sid2">SID2</label>
                    <input type="password" id="sid2" name="sid2" class="sid-input" required>
                </div>
                <div class="sid-col">
                    <label class="sid-label" for="sid4">SID4</label>
                    <input type="password" id="sid4" name="sid4" class="sid-input" required>
                </div>
            </div>
            <div class="remember-me-container">
                <input type="checkbox" id="remember_me" name="remember_me" class="remember-checkbox">
                <label for="remember_me" class="remember-label">Remember me</label>
            </div>
            <button type="submit" class="login-btn" id="loginBtn">[login]</button>
        </form>
        <div class="keyboard-hint">NAVIGATE: [↑] [↓] [←] [→] | CONFIRM: [ENTER]</div>
    </div>
    <!-- Используем matrix-animations.js - ту же анимацию, что и в register -->
    <script src="{{ url_for('static', filename='matrix-animations.js') }}"></script>
    <script>
        // Функция для запуска матричной анимации
        function setupMatrixEffect() {
            // Это обертка для запуска анимации после событий, таких как перезагрузка DOM
            const script = document.createElement('script');
            script.src = "{{ url_for('static', filename='matrix-animations.js') }}";
            document.head.appendChild(script);
        }
        
        // После успешного входа переход на /messenger
        function submitLoginForm() {
            const form = document.querySelector('form');
            fetch(form.action, {
                method: 'POST',
                body: new FormData(form)
            }).then(async resp => {
                if (resp.redirected) {
                    window.location.href = resp.url;
                } else {
                    // Проверяем, содержит ли ответ сообщение об ошибке
                    const respText = await resp.text();
                    if (respText.includes('error-message')) {
                        // Сохраняем текущий canvas с анимацией, если он есть
                        const canvas = document.getElementById('matrixCanvas');
                        let oldCanvas = null;
                        if (canvas) {
                            oldCanvas = canvas.cloneNode(true);
                        }
                        
                        // Обновляем содержимое страницы с ошибкой
                        document.body.innerHTML = respText;
                        
                        // Если был canvas, восстанавливаем его в начало body
                        if (oldCanvas) {
                            document.body.insertBefore(oldCanvas, document.body.firstChild);
                        }
                        
                        // Восстанавливаем обработчики событий
                        setupEventHandlers();
                        
                        // Если canvas был удален, запускаем анимацию заново
                        if (!document.getElementById('matrixCanvas')) {
                            setupMatrixEffect();
                        }
                    } else {
                        window.location.href = '/messenger';
                    }
                }
            });
        }
        
        // Функция для динамической загрузки скриптов
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        
        // Функция настройки обработчиков событий
        function setupEventHandlers() {
            // Remove click blocker
            /*
            document.removeEventListener('click', clickBlocker, true);
            document.addEventListener('click', clickBlocker, true);
            */
            
            // Обновляем ссылки на поля ввода
            const fields = [
                document.getElementById('sid1'),
                document.getElementById('sid2'),
                document.getElementById('sid3'),
                document.getElementById('sid4'),
                document.getElementById('loginBtn')
            ];
            let currentField = 0;
            fields[currentField].focus();
            
            // Проверка на ввод только латинских символов
            fields.forEach(field => {
                if (field && field.type === 'password') {
                    field.addEventListener('input', function(e) {
                        const englishOnly = /^[a-zA-Z0-9!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]*$/;
                        if (!englishOnly.test(this.value)) {
                            // Удаляем последний символ, если он не соответствует шаблону
                            this.value = this.value.slice(0, -1);
                        }
                    });
                }
            });
            
            // Add click handler for login button
            document.getElementById('loginBtn').addEventListener('click', function(e) {
                e.preventDefault();
                submitLoginForm();
            });
            
            // Удаляем предыдущий обработчик keydown, если он есть
            document.removeEventListener('keydown', keydownHandler);
            // Добавляем обработчик keydown
            document.addEventListener('keydown', keydownHandler);
        }
        
        // Функция блокировки кликов для сохранения ссылки - change to allow clicks on interactive elements
        function clickBlocker(e) {
            // Check if the clicked element is interactive
            const target = e.target;
            const isInteractive = target.tagName === 'INPUT' || 
                                target.tagName === 'BUTTON' || 
                                target.classList.contains('login-btn') ||
                                target.closest('.login-btn');
            
            if (!isInteractive) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
            
            return true;
        }
        
        // Обработчик нажатия клавиш
        function keydownHandler(e) {
            const fields = [
                document.getElementById('sid1'),
                document.getElementById('sid2'),
                document.getElementById('sid3'),
                document.getElementById('sid4'),
                document.getElementById('loginBtn')
            ];
            let currentField = fields.indexOf(document.activeElement);
            if (currentField === -1) currentField = 0;
            
            if (e.key === 'ArrowRight') {
                if (currentField === 0) currentField = 2;
                else if (currentField === 2) currentField = 0;
                else if (currentField === 1) currentField = 3;
                else if (currentField === 3) currentField = 1;
                else if (currentField === 4) currentField = 4;
                fields[currentField].focus();
                e.preventDefault();
            } else if (e.key === 'ArrowLeft') {
                if (currentField === 0) currentField = 2;
                else if (currentField === 2) currentField = 0;
                else if (currentField === 1) currentField = 3;
                else if (currentField === 3) currentField = 1;
                else if (currentField === 4) currentField = 4;
                fields[currentField].focus();
                e.preventDefault();
            } else if (e.key === 'ArrowDown') {
                if (currentField < 2) currentField += 1;
                else if (currentField === 2 || currentField === 3) currentField = 4;
                fields[currentField].focus();
                e.preventDefault();
            } else if (e.key === 'ArrowUp') {
                if (currentField === 1 || currentField === 0) currentField = 4;
                else if (currentField === 4) currentField = 2;
                else if (currentField > 2) currentField -= 1;
                fields[currentField].focus();
                e.preventDefault();
            } else if (e.key === 'Enter' && currentField === 4) {
                // Отправляем форму
                submitLoginForm();
                e.preventDefault();
            }
        }
        
        // Запуск обработчиков при загрузке страницы
        setupEventHandlers();
    </script>
</body>
</html> 